$(function(){var e=function(e){$("#bookRoomContent").scrollTop(0),h&&(h=""),$.showIndicator(),$.ajax({type:"POST",url:api+"/meeting/meetingList",data:{storey:e},dataType:"json",success:function(a){if(1e3===a.code){var n=template("roomBoxTpl",a);$("#roomBox").html(n);var r=template("roomBoxTplHead",a);$("#tableHead").html(r),t(e)}else $.alert(a.msg)},error:function(){$.hideIndicator(),$.alert("不好意思，出错了~~")}})},t=function(e){$.ajax({type:"POST",url:api+"/meeting/reserveList",data:{storey:e,date:$("#useDate .active").data("senddate")},dataType:"json",success:function(e){if($.hideIndicator(),1e3===e.code){for(var t=0,n=e.data.items.length;n>t;t++)for(var r=e.data.items[t],s=r.conferenceId,d=(r.conferenceName,r.dates),i=r.orgName,c=r.personName,o=r.title,l=r.mobile,f=$('[data-roomid="'+s+'"]'),h=startEndStr(d)[0],m=startEndStr(d)[2],b=["#03a9f4","#ff8e6b","#f6bf26","#f65e5e","#6bb5ce","#5c6bc0","#78c06e","#9a89b9","#a1887f","#78919d","#5e97f6","#bd84cd","#3bc2b5","#a1887f","#c5cb63"],v=0;v<f.length;v++){var p=f.eq(v),u=parseInt(p.parent().find("td").eq(0).data("start"),10),k="";if(k=o?i+"<br/>"+c+"<br/>"+o:i+"<br/>"+c,u==h){p.attr({rowspan:m,"data-mobile":l}).addClass("m-checked").css("background-color",b[t%b.length]).html('<a href="tel:'+l+'"><span class="m-checked-inner wrap-break">'+k+"</span></a>");for(var g=1;m>g;g++)f.eq(v+g).css("display","none");break}}a()}else $.alert(e.msg)},error:function(){$.hideIndicator(),$.alert("不好意思，出错了~~")}})},a=function(){var e=parseInt(n.getHours()+1,10),t='<div class="checked-item-timeout">过期</div>';$(".m-table").find("td").each(function(){var a=$(this),n=(a.parent(),parseInt(a.parent().find("td").eq(0).data("start"),10));!a.hasClass("m-checked")&&a.index()&&e>n&&$("#useDate").find("a").eq(0).hasClass("active")&&a.html(t)})},n=new Date,r=n.getFullYear(),s=n.getMonth()+1,d=n.getDate(),i=new Array("周日","周一","周二","周三","周四","周五","周六"),c=n.getDay(),o=[0,1,2];switch(c){case 0:o=[1,2,3];break;case 4:o=[0,1,4];break;case 5:o=[0,3,4];break;case 6:o=[2,3,4]}$("#useDate").html("");for(var l=0;3>l;l++){var f=(n.getDay()+o[l])%7;$("#useDate").append('<a href="javascript:;" class="tab-links button" data-senddate='+r+"-"+("00"+s).substr(-2)+"-"+(d+l)+">"+i[f]+"("+("00"+s).substr(-2)+"-"+(d+o[l])+")</a>")}$("#useDate").find("a").eq(0).addClass("active"),e(6);var h="",m=[];$(document).on("click",".m-table td",function(e){var t=$(this);if(!t.find(".checked-item-timeout").length){if(!t.hasClass("m-checked")){var a=t.siblings("td").eq(0),n=(a.data("start"),a.data("end"),t.index());if(h||(h=n),n){var r=parseInt(t.parents("tr").attr("id"),10),s=t.find(".checked-item");if(s.length){var d=m[0],i=m[m.length-1];if(1===m.length&&s.remove(),r==i)m[m.length-1]=i-1,$("#"+i).find("td").eq(n).html("");else{for(var c=d;r>=c;c++)$("#"+c).find("td").eq(n).html("");m[0]=r+1}$(".checked-item").length||(h="")}else if(h===n){var o='<div class="checked-item"><span class="icon icon-check"></span></div>';t.html(o);var l=$(".checked-item");if($(".checked-item").length>1){m.length&&(m=[]),m[0]=parseInt(l.first().parents("tr").attr("id"),10),m[1]=parseInt(l.last().parents("tr").attr("id"),10);for(var c=m[0];c<=m[m.length-1];c++)if($(".m-table").find($("#"+c)).find("td").eq(n).hasClass("m-checked"))return $.alert("请选择连续的开会时间段"),t.html(""),!1;$(".checked-item").each(function(){$(this).remove()});for(var c=m[0];c<=m[m.length-1];c++)$(".m-table").find($("#"+c)).find("td").eq(n).html(o)}else m=[],m[0]=parseInt(l.first().parents("tr").attr("id"),10)}else h!==n&&$.alert("不同会议室请分开预定!")}}$(".checked-item").length?$(".js-bookbtn").parent("nav").addClass("db"):$(".js-bookbtn").parent("nav").removeClass("db")}}),$(".js-tabs").on("click","a",function(){var t,a=$(this);a.addClass("active").siblings().removeClass("active"),t=a.parent().hasClass("radio-list")?a:$(".radio-list").find(".active");var n=t.find(".storey-num").text();e(n)}),$(".js-bookbtn").on("click",function(){for(var e=$("#useDate").children(".active").text(),t=$("#useDate").children(".active").data("senddate"),a=$(".m-table").find(".checked-item").eq(0).parent().data("room"),n=($(".m-table").find(".checked-item").eq(0).index(),$(".m-table").find(".checked-item").eq(0).parent().data("roomid")),r=parseInt($("#"+m[0]).find("td").eq(0).data("start"),10),s=parseInt($("#"+m[m.length-1]).find("td").eq(0).data("end"),10),d="",i="",c=r;s>c;c++){var o=",";c===r&&(o=""),12!==c&&13!==c&&(d+=o+c+"-"+(c+1),i+=o+c+":00-"+(c+1)+":00")}var l={useDate:e,sendDate:t,dates:d,conference:a,roomId:n,datesShow:i};window.sessionStorage.setItem("bookVal",JSON.stringify(l))})});